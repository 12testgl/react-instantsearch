version: 2
jobs:
  test_build:
    working_directory: ~/react-instantsearch
    docker:
      - image: circleci/node:8.11.4
    steps:
      - checkout
      - run:
          name: Install specific Yarn version
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.9.4
            echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV
      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn install
      - save_cache:
          name: Save Yarn cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Build & Test packages size
          command: yarn test:build

  test_unit:
    working_directory: ~/react-instantsearch
    docker:
      - image: circleci/node:8.11.4
    steps:
      - checkout
      - run:
          name: Install specific Yarn version
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.9.4
            echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV
      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn install
      - save_cache:
          name: Save Yarn cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Lint & Code styles
          command: yarn lint
      - run:
          name: Unit Tests
          command: yarn test:ci

  test_e2e:
    working_directory: ~/react-instantsearch
    docker:
      - image: circleci/node:8.11.4-browsers
    environment:
      FIREFOX_VERSION: '56.0'
    steps:
      - checkout
      - run:
          name: Install specific FF version
          command: |
            wget -O "/tmp/firefox-$FIREFOX_VERSION.tar.bz2" "https://download-installer.cdn.mozilla.net/pub/firefox/releases/$FIREFOX_VERSION/linux-x86_64/en-US/firefox-$FIREFOX_VERSION.tar.bz2"
            tar -jxf "/tmp/firefox-$FIREFOX_VERSION.tar.bz2" -C "/tmp/"
            sudo mv "/tmp/firefox" "/opt/firefox-$FIREFOX_VERSION"
            sudo ln -sf "/opt/firefox-$FIREFOX_VERSION/firefox" "/usr/bin/firefox"
            hash -r
            firefox --version
      - run:
          name: Install specific Yarn version
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.9.4
            echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV
      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn install
      - save_cache:
          name: Save Yarn cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: E2E Tests
          command: yarn test:e2e

  test_examples:
    working_directory: ~/react-instantsearch
    docker:
      - image: circleci/node:8.11.4
    steps:
      - checkout
      - run:
          name: Install specific Yarn version
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.9.4
            echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV
      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
          name: Install dependencies
          command: yarn install
      - save_cache:
          name: Save Yarn cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn
      - run:
          name: Build & Test examples
          command: yarn test:examples

workflows:
  version: 2
  ci:
    jobs:
      - test_build
      - test_unit
      - test_e2e
      - test_examples
