version: 2
jobs:
  build:
    working_directory: ~/react-instantsearch

    docker:
      - image: circleci/node:8.11.4

    environment:
      FIREFOX_SOURCE_URL: https://download.mozilla.org/?product=firefox-56.0&lang=en-US&os=linux64

    steps:
      - checkout

      - run:
          name: Install specific FF version
          command: |
            wget --no-verbose -O $HOME/firefox-56.0.tar.bz2 $FIREFOX_SOURCE_URL
            tar xjf $HOME/firefox-56.0.tar.bz2
            echo 'export PATH="$HOME/firefox-56.0/firefox:$PATH"' >> $BASH_ENV
            echo $PATH
            firefox --version

      - run:
          name: Install specific Yarn version
          command: |
            curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version 1.9.4
            echo 'export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"' >> $BASH_ENV

      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-packages-{{ checksum "yarn.lock" }}

      - run:
          name: Install dependencies
          command: |
            yarn install

      - save_cache:
          name: Save Yarn cache
          key: yarn-packages-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

      - run: yarn lint
      - run: yarn test:ci
      - run: yarn test:e2e
      - run: yarn test:build
      - run: yarn test:examples
